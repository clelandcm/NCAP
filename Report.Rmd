---
title: "NCAP Summaries"
author: "Last Updated"
date: '`r format(Sys.time(), "%B %d, %Y %r %Z")`'
output:
  html_document:
    highlight: tango
    theme: journal
    toc: yes
    toc_float: 
      collapsed: false
    toc_depth: 5
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, comment=NA, fig.width = 3, fig.asp = 0.618, out.width = "100%", fig.align = "center", dev='svg')
```

```{r}
library(openxlsx)
library(dplyr)
library(tidyr)
library(ggplot2)
library(DiagrammeR)
library(ggthemes)
library(scales)
library(DiagrammeRsvg)
library(svglite)
library(rsvg)
library(png)
library(XML)
library(data.table)
library(table1)
library(pander)
library(kableExtra)
library(ggconsort)

panderOptions('table.split.table', Inf)
```

```{r, eval=FALSE}
# https://github.com/tgerke/ggconsort
# https://tgerke.github.io/ggconsort/

https://youtu.be/a8A638n6Qew 

devtools::install_github("tgerke/ggconsort")
```

```{r}
# https://stackoverflow.com/questions/71064769/how-do-we-insert-n-every-n-character-or-and-after-n-th-space-in-a-string-in-r
# paste(strwrap(paste(rep("A", 1000), collapse = " "), width = 50), collapse = "<br/>")
```


```{r}
tkns <- read.xlsx("tokens.xlsx")

library(REDCapR)
uri <- "https://redcap.nyu.edu/api/"
token <- tkns[1,2]

# meta_DT <- redcap_metadata_read(redcap_uri = uri, token=token)$data

meta_DT <- read.xlsx("NCAPTrial_DataDictionary_2022-10-10.xlsx", cols = 1:6)

names(meta_DT)[1:6] <- c("var","form","header","type","label","choices")

setDT(meta_DT)

meta_DT[grepl("^round|^sum", choices) == TRUE, choices := NA]
meta_DT[type %in% c("calc","slider"), choices := NA]
meta_DT[var != "rand_condition" & type == "dropdown", choices := NA]
meta_DT[var == "loc_language", choices := NA]

meta_DT[!is.na(choices), choices := paste(gsub(";", ",", choices))]
meta_DT[!is.na(choices), choices := paste(gsub("Don't", "Do not", choices))]
meta_DT[!is.na(choices), choices := paste(gsub("0, No\\|1, Yes\\|997, Do not Know", "0, No \\| 1, Yes \\| 997, Do not Know", choices))]
meta_DT[!is.na(choices), choices := paste(gsub("0, No\\| 1, Yes", "0, No \\| 1, Yes", choices))]
meta_DT[!is.na(choices), choices := paste(gsub("1, Not at all \\| 2, A little\\|3, Somewhat \\|4, Quite a bit \\|5, A great deal  \\|997, Do not Know \\| 998, Refuse to Answer",
                                               "1, Not at all \\| 2, A little \\| 3, Somewhat \\| 4, Quite a bit \\| 5, A great deal \\| 997, Do not Know \\| 998, Refuse to Answer", choices))]
meta_DT[!is.na(choices), choices := paste(gsub("2,  \\||4,  \\|", "", choices))]
meta_DT[!is.na(choices), factlab := paste(gsub(" \\| ", "';", gsub("([0-9]), ", "\\1='", gsub("'", "", choices))), "'", sep = "")]
meta_DT[!is.na(label), attriblab := gsub("\n", "", label)]
meta_DT[!is.na(attriblab), attriblab := gsub("<[^>]*>", "", attriblab)]

meta_DT[!is.na(choices), factlab := gsub("<.*?>", "", factlab)]
meta_DT[!is.na(attriblab), attriblab := gsub("<.*?>", "", attriblab)]

# meta_DT[!is.na(attriblab), attriblab := paste(strwrap(paste(attriblab, collapse = " "), width = 60), collapse = "<br>")]

DT <- REDCapR::redcap_read(redcap_uri=uri, raw_or_label = "raw", token=token)$data

# setDT(DT)

## Recode Multiple Choice Fields to Factors
val_labs <- intersect(meta_DT$var[!is.na(meta_DT$choices)], names(DT))

vlabmatch <- data.frame(var = val_labs, 
                        DT_index = match(val_labs, names(DT)),
                        ddict_index = match(val_labs, meta_DT$var))

vlabmatch$factlab <- meta_DT$factlab[vlabmatch$ddict_index]

for(i in 1:length(val_labs)){
DT[,vlabmatch$DT_index[i]] <- car::recode(var = DT[,vlabmatch$DT_index[i]], 
                                                recodes = vlabmatch$factlab[i],
                                                levels = strsplit(x = gsub("\\d+=|'", "", vlabmatch$factlab[i]), split = ";")[[1]],
                                                as.factor = TRUE)
}

## Apply Variables Labels
var_labs <- intersect(meta_DT$var[!is.na(meta_DT$attriblab)], names(DT))

alabmatch <- data.frame(var = var_labs,
                        DT_index = match(var_labs, names(DT)),
                        ddict_index = match(var_labs, meta_DT$var))

# alabmatch$fieldlabel <- paste(alabmatch$var, meta_DT$attriblab[alabmatch$ddict_index], sep = ": ")

alabmatch$fieldlabel <- meta_DT$attriblab[alabmatch$ddict_index]

for(i in 1:length(var_labs)){
attributes(DT[, alabmatch$DT_index[i]])$label <- alabmatch$fieldlabel[i]  
}

setDT(DT)
```

```{r}
DT[participant_id == "DMA010287F", participant_id := "DOMA010287"]
DT[participant_id == "SBO070186M", participant_id := "SHBO070186"]
```

```{r, eval = FALSE}
save(list=c('DT'), file = "ncap.Rdata")
```

```{r}
ncap_cohort <- DT %>% 
  cohort_start("Screening Consent Initiated<br>") %>%
    cohort_define(
    scr1 = .full %>% filter(redcap_event_name == "screener_consent_arm_1" & screening_consent_form_complete %in% c(0,1,2)),
    scr2 = .full %>% filter(redcap_event_name == "screener_arm_1"),
    s2_e = .full %>% filter(redcap_event_name == "screener_arm_1" & eligibility == 'ELIGIBLE'),
    s2_ie = .full %>% filter(redcap_event_name == "screener_arm_1" & eligibility == 'INELIGIBLE'),
    enrl = .full %>% filter(redcap_event_name == "consent_form_arm_2" & consent_form_complete == 2),
    bl = .full %>% filter(redcap_event_name == "baseline_interview_arm_2" & !is.na(n_baseline_end)),
    rand = .full %>% filter(redcap_event_name == "randomization_arm_2" & !is.na(rand_condition))
    ) %>%
  cohort_label(
    scr1 = "Screening Consent<br>Initiated<br>",
    scr2 = "Full Screening<br>Initiated<br>",
    s2_e = "Eligible<br>",
    s2_ie = "Ineligible<br>",
    enrl = "Enrolled<br>",
    bl = "Baseline Interview<br>",
    rand = "Assigned to Condition<br>"
  )
```

```{r}
study_consort <- ncap_cohort %>%
  consort_box_add(
    "scr1", 0, 50, cohort_count_adorn(ncap_cohort, scr1)
  ) %>%
  consort_box_add(
    "scr2", 0, 40, cohort_count_adorn(ncap_cohort, scr2)
  ) %>%
    consort_box_add(
    "s2_ie", 10, 37.5, cohort_count_adorn(ncap_cohort, s2_ie)
  ) %>%    
      consort_box_add(
    "s2_e", 0, 30, cohort_count_adorn(ncap_cohort, s2_e)
  ) %>%    
      consort_box_add(
    "bl", 0, 20, cohort_count_adorn(ncap_cohort, bl)
  ) %>%    
      consort_box_add(
    "rand", 0, 10, cohort_count_adorn(ncap_cohort, rand)
  ) %>%    
 consort_arrow_add(start = "scr1", end = "scr2", end_side = "top") %>%
# consort_arrow_add(start = "scr2", end = "s2_ie", start_side = "right", end_side = "left") %>%
  consort_arrow_add(start_x = 0, start_y = 37.5, end = "s2_ie", end_side = "left") %>%
  consort_arrow_add(start = "scr2", end = "s2_e", end_side = "top") %>%
     consort_arrow_add(start = "s2_e", end = "bl", end_side = "top") %>%
  consort_arrow_add(start = "bl", end = "rand", end_side = "top") 
```

# CONSORT
```{r, include = TRUE, fig.width = 9, fig.height = 4, dev='svg'}
study_consort %>%
  ggplot() + 
  geom_consort() +
  theme_consort(margin_h = 4, margin_v = 4)
```

# Enrollment
```{r, fig.width = 6, fig.asp = 0.8, out.width = "90%"}
enroll_new <- data.frame(day = seq(as.Date("2022-07-01"), as.Date("2023-11-01"), 1))

setDT(enroll_new)

DT[, bl_date := as.Date(format(n_baseline_end, "%Y-%m-%d"))]

enroll_new <- merge(enroll_new, DT[!is.na(bl_date), .(Enrolled = .N), by = .(bl_date)], by.x = "day", by.y = "bl_date", all=TRUE)

enroll_new[is.na(Enrolled), Enrolled := 0]
enroll_new[, Row := 1:.N]
enroll_new[, Target := 1.128463]
enroll_new[, `Cumulative Enrolled` := cumsum(Enrolled)]
enroll_new[, `Cumulative Target` := cumsum(Target)]
enroll_new[`Cumulative Target` >= 448, `Cumulative Target` := 448]
enroll_new[, Deficit := `Cumulative Target` - `Cumulative Enrolled`]

enroll_new_m <- melt(enroll_new, id.vars = c("day","Row"), 
                     variable.name = "type",
                     value.name = "num")

# figtop <- ceiling(enroll_new_m[day == Sys.Date() & type %in% c('Cumulative Enrolled','Cumulative Target'), .(max(num))])$V1

# while(figtop %% 12 > 0) {figtop <- figtop + 1}

figtop <- 448

enroll_new_m[day > Sys.Date() & type == "Cumulative Enrolled", num := NA]
enroll_new_m[type == "Cumulative Target" & num > 448, num := 448]

ggplot(enroll_new_m[type %in% c('Cumulative Enrolled','Cumulative Target'),], 
       aes(x = day, y = num, group = type, color = type)) + 
  geom_path() +
  scale_y_continuous(limits=c(0,figtop), breaks=seq(0,figtop,28)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b '%y") +
  ylab("Cumulative Number Enrolled") + xlab("") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size=6),
        axis.text.y = element_text(size=6),
        axis.title.y = element_text(size=6),
        legend.position="bottom", 
        legend.text=element_text(size=6),
        legend.title = element_blank())
```

```{r}
enroll_new[day == Sys.Date(), .(`Cumulative Enrolled`, 
                                `Cumulative Target` = ceiling(`Cumulative Target`), 
                                `Current Deficit` = ceiling(Deficit))] %>%
  kbl(., booktabs = T, escape = F, align = "c") %>%
  kable_paper("hover", full_width = FALSE)
```

# Select Screening Items
```{r}
raceth_m <- melt(DT[redcap_event_name == "screener_arm_1", .SD, 
                    .SDcols = names(DT) %like% "^race_ethn_race___\\d+|participant_id"], 
                id.vars = "participant_id")

raceth_m <- raceth_m[!value == 0,]
raceth_m[, Ncheck := .N, by = .(participant_id)]
raceth_m[, variable := gsub("race_ethn_race___", "", variable)]
raceth_m[, variable := car::recode(variable, "1='American Indian or Alaska Native';
                                              2='Black or African American';
                                              3='Asian';
                                              4='Native Hawaiian or  Other Pacific Islander';
                                              5='White';
                                             15='Some other race';
                                             99='Prefer not to answer'")]

DT <- merge(DT, raceth_m[, .(Race = paste(variable, collapse = "; ")), by = .(participant_id)], all = TRUE, by = "participant_id")

label(DT$Race) <- "Race categories checked"
```

```{r}
DT[, screening_complete := car::recode(screening_complete, "0='Incomplete';1='Unverified';2='Complete'", as.factor = TRUE)]
label(DT$screening_complete) <- "Screening Complete?"

table1(~ consent_given + n_recruitment_method + 
         n_interview_format + age_yrs + n_language + n_pref_language + 
         Race + race_ethn_hispanic +
         current_county + tested_for_covid + tested_positive_for_covid +
         screening_complete + eligibility, 
       data = DT[redcap_event_name == "screener_arm_1",])
```

## Vaccination 
```{r}
label(DT$covid_vaccine) <- "Have you received a COVID-19 vaccine?(RADxUP CDE #90)"

table1(~ covid_vaccine, 
       data = DT[redcap_event_name == "screener_arm_1",])
```

### Willing to check records (among those eligible on earlier criteria and with a Yes or No response to vaccination)
```{r}
label(DT$n_mvr) <- "Are you willing to check MY VACCINE RECORD, even if you have not been vaccinated at all for COVID-19, or are you</br>willing to let me check it for you while we are on the phone together?"

table1(~ n_mvr, 
       data = DT[covid_vaccine %in% c('Yes','No') &
                 scr_notif_14 == "No (Participant meets ALL eligibility criteria so far - ask MVR questions)" &
                 redcap_event_name == "screener_arm_1",])
```

### Proof method among those reporting vaccination and eligible on earlier criteria
```{r}
table1(~ n_vaccine_proof, 
       data = DT[covid_vaccine %in% c('Yes') &
                 scr_notif_14 == "No (Participant meets ALL eligibility criteria so far - ask MVR questions)" &   
                 redcap_event_name == "screener_arm_1",])
```

### Vaccine received among those reporting vaccination and eligible on earlier criteria
```{r}
DT[, vaccine_dose := car::recode(vaccine_dose, "1='One';2='Two';3:hi='Three or More'", 
                                 as.factor = TRUE, levels = c('One','Two','Three or More'))]

label(DT$vaccine_manufac_2) <- "Who was the manufacturer of the most recent vaccine you received? (RADxUP CDE #181)"
label(DT$vaccine_dose) <- "How many doses have you received?(RADxUP CDE #183)"

table1(~ vaccine_manufac_2 + vaccine_dose, 
       data = DT[covid_vaccine %in% c('Yes') &
                 scr_notif_14 == "No (Participant meets ALL eligibility criteria so far - ask MVR questions)" &   
                 redcap_event_name == "screener_arm_1",])
```

### What does documentary evidence show among those providing it
```{r}
DT[, n_dose_check := car::recode(n_dose_check, "0='No';1='Yes'", as.factor = TRUE)]

label(DT$n_dose_check) <- "Does vaccination card or documentary evidence indicate that participant has 2 or more doses of any COVID-19 vaccine?"

table1(~ n_dose_check, 
       data = DT[scr_notif_14 == "No (Participant meets ALL eligibility criteria so far - ask MVR questions)" &
                 !is.na(n_vaccine_proof) &
                 n_vaccine_proof %in% c('My Vaccine Record', 
                                        'CDC Vaccination Card', 
                                        'Other documentary evidence') &
                 redcap_event_name == "screener_arm_1",])
```

# Reasons for Ineligibility
```{r}
DT[redcap_event_name == "screener_arm_1", 
     `:=` (IE_consent = consent_given == "No, consent is not required/is waived for this study",
           IE_age = age_yrs < 18 | age_yrs > 70,
           IE_race_ethn = (race_ethn_hispanic == "No, not of Hispanic, Latino, or Spanish origin" | race_ethn_hispanic == "Prefer not to answer") & 
                          (race_ethn_race___1 == 1 |
                           race_ethn_race___3 == 1 | 
                           race_ethn_race___4 == 1 |
                           race_ethn_race___5 == 1 |
                           race_ethn_race___15 == 1) &
                           race_ethn_race___1 != 1,
           IE_language = n_language != "Yes",
           IE_location = n_current_location == "No",
           IE_work = n_work_status == "No",
           IE_occupation = n_current_occupation == "Other" | n_current_occupation == "Prefer not to answer",
           IE_vaccine = (covid_vaccine == "Yes" & vaccine_manufac_2 == "Johnson & Johnson") | vaccine_dose != "One",
           IE_covid_test = n_tested_for_covid_6mo != "No",
           IE_previous = n_previous_participation == "Yes",
           IE_cab = n_cab_member == "Yes",
           IE_guidelines = n_covid_guidelines == "No",
           IE_cell = n_cell_use == "No",
           IE_symptoms = n_covid_symptoms_2wks == "Yes")]

label(DT$IE_consent) <- "No consent given"
label(DT$IE_age) <- "Does not meet age criteria"
label(DT$IE_race_ethn) <- "Does not identify as part of an eligible racial/ethnic group"
label(DT$IE_language) <- "Cannot participate in activities conducted in English or Spanish"
label(DT$IE_location) <- "Does not live in NYC"
label(DT$IE_work) <- "Has not worked full-time or part-time in the past month"
label(DT$IE_occupation) <- "Does not work in an eligble occupation"
label(DT$IE_vaccine) <- "Fully vaccinated"
label(DT$IE_covid_test) <- "Tested for COVID in the past six months"
label(DT$IE_previous) <- "Previous participant"
label(DT$IE_cab) <- "CAB Member"
label(DT$IE_guidelines) <- "Not willing to follow NYU COVID guidelines"
label(DT$IE_cell) <- "No cell phone for study participation"
label(DT$IE_symptoms) <- "COVID Symptoms in Past Two Weeks"
```

```{r}
table1(~ ., data = DT[redcap_event_name == "screener_arm_1", .SD, .SDcols = names(DT) %like% "^IE_"])
```
# Baseline

```{r}
Enrolled <- subset(DT, redcap_event_name == "baseline_interview_arm_2" & !is.na(n_baseline_end))$participant_id
```

## Demographics
```{r}
table1(~ age_yrs +
         Race + race_ethn_hispanic + n_current_occupation,
       data = DT[redcap_event_name == "screener_arm_1" & participant_id %in% Enrolled,])
```

<br>

```{r}
DT <- merge(DT, na.omit(DT[, .(participant_id, sex_Birth = bio_sex_birth_2)]), by = "participant_id", all = TRUE)
label(DT$sex_Birth) <- label(DT$bio_sex_birth_2)

DT[, language_pref := car::recode(language_pref, "9='English';1='Spanish';NA='Missing';else='Other'", as.factor = TRUE, levels=c('English','Spanish','Other'))]

label(DT$language_pref) <- "What is your preferred language at home? (RADxUP CDE #47)"

table1(~ sex_Birth + edu_years_of_school +    
         gender_identity_term + sex_orient_id + language_pref +
         discrimination_ethnicity + family_income + pregnancy_status, 
       data = DT[redcap_event_name == "baseline_interview_arm_2",])
```

<br>

```{r}
DT[, Parent := household_famgen_3 %in% c("Family including kids",
                                         "Family with 3 generations (parents, children, grandchildren)",
                                         "Family with 4 generations")]

label(DT$Parent) <- "Participant is a parent"

table1(~ household_famgen_3 + Parent, 
       data = DT[redcap_event_name == "baseline_interview_arm_2",])
```

## What languages are spoken at home?
```{r}
langhome <- names(DT)[grepl("^language_home___", names(DT))]

DT[ , (langhome) := lapply(.SD, function(x){factor(x, levels = c(0,1), labels = c('Unchecked','Checked'))}), .SDcols = langhome]

label(DT$language_home___9) <- "English"             
label(DT$language_home___1) <- "Spanish"             
label(DT$language_home___10) <- "Albanian"            
label(DT$language_home___11) <- "Apache"              
label(DT$language_home___12) <- "Arabic"              
label(DT$language_home___13) <- "Bengali/Bangla"      
label(DT$language_home___14) <- "Bhutanese"           
label(DT$language_home___15) <- "Burmese"             
label(DT$language_home___4) <- "Cantonese"           
label(DT$language_home___16) <- "Cape Verdean Creole" 
label(DT$language_home___17) <- "Creole"              
label(DT$language_home___18) <- "Chamoru"             
label(DT$language_home___19) <- "Chuukese"            
label(DT$language_home___20) <- "Dakota"              
label(DT$language_home___21) <- "Fijian"              
label(DT$language_home___22) <- "French"              
label(DT$language_home___6) <- "Hawaiian"            
label(DT$language_home___23) <- "Hmong"               
label(DT$language_home___7) <- "Ilokano"             
label(DT$language_home___24) <- "Karen"               
label(DT$language_home___25) <- "Khmer/Cambodian"     
label(DT$language_home___26) <- "Kinyarwanda"         
label(DT$language_home___27) <- "Korean"              
label(DT$language_home___28) <- "Kosraean"            
label(DT$language_home___29) <- "Lakota"              
label(DT$language_home___30) <- "Lingala"             
label(DT$language_home___31) <- "Mam"                 
label(DT$language_home___3) <- "Mandarin"            
label(DT$language_home___32) <- "Marshallese"         
label(DT$language_home___33) <- "Mixteco"             
label(DT$language_home___34) <- "Nakota"              
label(DT$language_home___8) <- "Navajo"              
label(DT$language_home___35) <- "Nepali"              
label(DT$language_home___36) <- "Portuguese"          
label(DT$language_home___37) <- "Pohnpeian"           
label(DT$language_home___38) <- "Russian"             
label(DT$language_home___39) <- "Sign Language"       
label(DT$language_home___40) <- "Somali"              
label(DT$language_home___41) <- "Samoan"              
label(DT$language_home___42) <- "Swahili"             
label(DT$language_home___5) <- "Tagalog"             
label(DT$language_home___43) <- "Thai"                
label(DT$language_home___44) <- "Tongan"              
label(DT$language_home___45) <- "Triqui"              
label(DT$language_home___2) <- "Vietnamese"          
label(DT$language_home___46) <- "Zapoteco"            
label(DT$language_home___90) <- "Other"               
label(DT$language_home___99) <- "Prefer not to answer"

table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^language_home"])
```

## Vaccination Status Items
```{r}
label(DT$covid_vaccine) <- "Have you received a COVID-19 vaccine?(RADxUP CDE #90)"

table1(~ covid_vaccine, 
       data = DT[redcap_event_name == "screener_arm_1" & participant_id %in% Enrolled,])
```

### Willing to check records (among those eligible on earlier criteria and with a Yes or No response to vaccination)
```{r}
label(DT$n_mvr) <- "Are you willing to check MY VACCINE RECORD, even if you have not been vaccinated at all for COVID-19, or are you</br>willing to let me check it for you while we are on the phone together?"

table1(~ n_mvr, 
       data = DT[covid_vaccine %in% c('Yes','No') &
                 scr_notif_14 == "No (Participant meets ALL eligibility criteria so far - ask MVR questions)" &
                 redcap_event_name == "screener_arm_1" & participant_id %in% Enrolled,])
```

### Proof method among those reporting vaccination and eligible on earlier criteria
```{r}
table1(~ n_vaccine_proof, 
       data = DT[covid_vaccine %in% c('Yes') &
                 scr_notif_14 == "No (Participant meets ALL eligibility criteria so far - ask MVR questions)" &   
                 redcap_event_name == "screener_arm_1" & participant_id %in% Enrolled,])
```

### Vaccine received among those reporting vaccination and eligible on earlier criteria
```{r}
DT[, vaccine_dose := car::recode(vaccine_dose, "1='One';2='Two';3:hi='Three or More'", 
                                 as.factor = TRUE, levels = c('One','Two','Three or More'))]

label(DT$vaccine_manufac_2) <- "Who was the manufacturer of the most recent vaccine you received? (RADxUP CDE #181)"
label(DT$vaccine_dose) <- "How many doses have you received?(RADxUP CDE #183)"

table1(~ vaccine_manufac_2 + vaccine_dose, 
       data = DT[covid_vaccine %in% c('Yes') &
                 scr_notif_14 == "No (Participant meets ALL eligibility criteria so far - ask MVR questions)" &   
                 redcap_event_name == "screener_arm_1" & participant_id %in% Enrolled,])
```

### What does documentary evidence show among those providing it
```{r}
DT[, n_dose_check := car::recode(n_dose_check, "0='No';1='Yes'", as.factor = TRUE)]

label(DT$n_dose_check) <- "Does vaccination card or documentary evidence indicate that participant has 2 or more doses of any COVID-19 vaccine?"

table1(~ n_dose_check, 
       data = DT[scr_notif_14 == "No (Participant meets ALL eligibility criteria so far - ask MVR questions)" &
                 !is.na(n_vaccine_proof) &
                 n_vaccine_proof %in% c('My Vaccine Record', 
                                        'CDC Vaccination Card', 
                                        'Other documentary evidence') &
                 redcap_event_name == "screener_arm_1" & participant_id %in% Enrolled,])
```


## Health status, current housing, and current job status
```{r}
DT[household_famgen_3 != "None of these", household_homeless := "No"]

DT[, n_birthplace := car::recode(n_birthplace, "1='USA (mainland, Hawaii, Alaska)';
2='Puerto Rico';
3='Other North America, including Mexico';
4='Central America';
5='Caribbean';
6='South America';
7='Europe, including Eastern Russia';
8='Asia';
9='Australia';
10='Africa';
11='Other';
98='Do not know';
99='Refuse to answer';
12='Not applicable';
13='Other'", as.factor = TRUE, 
levels = c('USA (mainland, Hawaii, Alaska)',
'Puerto Rico',
'Other North America, including Mexico',
'Central America',
'Caribbean',
'South America',
'Europe, including Eastern Russia',
'Asia',
'Australia',
'Africa',
'Other',
'Do not know',
'Refuse to answer',
'Not applicable'))]

label(DT$n_birthplace) <- "In what country or territory were you born?"

table1(~ selfphysical_parent + selfmental_parent + household_famgen_3 + household_homeless + 
         household_congregate_3 + n_birthplace + n_immigration + jobloss_covid19_2 + 
         current_employment_status + employed_ew + employed_healthcare_2 + 
         hi_coverage_type + hi_loss_covid, 
       data = DT[redcap_event_name == "baseline_interview_arm_2",])
```

## The COVID-19 pandemic may cause challenges for some people, whether they get COVID-19 or not. In the past 6 months have you or your family experienced any of these challenges? (RADxUP CDE #38)
```{r}
table1(~ cov_pan_chal_hlth_2 + covid_pandemic_challenges_abod_2 + covid_pandemic_challenges_food_2 + 
         covid_pandemic_challenges_wate_2 + cov_pan_chal_med_2 + cov_pan_chlng_trans_2, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

## Work, PPE, & Distancing
```{r}
table1(~ work_wash_2 + work_closecont_2 + work_ppe_2,
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

## Medical History
```{r}
table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^cc_"])
```

## COVID-19 Knowledge
```{r}
table1(~ n_knowledge_1 + n_knowledge_2 + n_knowledge_3 + n_knowledge_4 + n_knowledge_5 + 
         n_knowledge_6 + n_knowledge_7 + n_knowledge_8 + n_knowledge_9 + n_knowledge_10, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

```{r}
covknow <- melt(DT[redcap_event_name == "baseline_interview_arm_2", 
                   .SD, .SDcols = names(DT) %like% "participant_id|n_knowledge_\\d+$"], 
                id.vars = "participant_id", variable.name = "Item",
                value.name = "Response")

covknow[, Item := as.numeric(gsub("n_knowledge_", "", Item))]
covknow[, Item_cat := factor(paste0("Item ", Item), 
                             levels = c("Item 1", "Item 2","Item 3","Item 4","Item 5",
                                        "Item 6","Item 7","Item 8","Item 9","Item 10"))]

covknow[Item %in% c(1,2,3,5,7), Correct := ifelse(Response == "True", "Yes", "No")]
covknow[Item %in% c(4,6,8,9,10), Correct := ifelse(Response == "False", "Yes", "No")]

covknowsum <- covknow[, .(COVID_Knowledge_Total = sum(Correct == "Yes", na.rm = TRUE)), 
                      by = .(participant_id)]

label(covknowsum$COVID_Knowledge_Total) <- "COVID Knowledge Total (0-10)"
```

<br>

```{r}
table1(~ COVID_Knowledge_Total, data = covknowsum)
```

## Thoughts regarding getting tested for COVID-19 and vaccines
```{r}
table1(~ flu_vaccinehistind_2 + flu_vaccine_season_3 + vaccine_avail + 
         vaccine_requirement + vaccine_booster + isolate_maintain_job +
         quarantine_maintain_job + test_accesswhere_2 + test_accesseasy_2 + test_intent_2,
data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

## Motivation/Readiness/Stage of Change
```{r}
DT[, motivation_4 := motivation_4 / 10]

table1(~ motivation_1 + motivation_2 + motivation_3 + motivation_4 + 
         motivation_5 + motivation_6 + motivation_7 + motivation_8, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

```{r}
DT[, Regular_Testing := rowSums(.SD, na.rm = FALSE), .SDcols = c("motivation_1","motivation_2")]
DT[, Symptomatic_Testing := rowSums(.SD, na.rm = FALSE), .SDcols = c("motivation_3","motivation_4")]
DT[, Vax_Full := rowSums(.SD, na.rm = FALSE), .SDcols = c("motivation_5","motivation_6")]
DT[, Vax_Boost := rowSums(.SD, na.rm = FALSE), .SDcols = c("motivation_7","motivation_8")]

label(DT$Regular_Testing) <- "Readiness for regular COVID testing (0-20)"
label(DT$Symptomatic_Testing) <- "Readiness for COVID testing when symptomatic (0-20)"
label(DT$Vax_Full) <- "Readiness for full vaccination (0-20)"
label(DT$Vax_Boost) <- "Readiness for vaccine booster (0-20)"
```

<br>

```{r}
table1(~ Regular_Testing + Symptomatic_Testing + Vax_Full + Vax_Boost, 
       data = DT[redcap_event_name == "baseline_interview_arm_2",])
```

## Tier 2 COVID
```{r}
table1(~ covid_had + tested_positive_for_covid +
         positiveyear_covidtest_3 + positivemonth_covidtest_2 +
         recentresult_covidtest + cov_tst_mthd_2 + covid_risk, 
       data = DT[redcap_event_name == "baseline_interview_arm_2",])
```

## Vaccine Acceptance
```{r}
table1(~ vaccine_safe_2 + vaccine_effective_2 + vaccine_free_2 +
         vaccine_no_pain_2 + vaccine_conven_2, 
       data = DT[redcap_event_name == "baseline_interview_arm_2",])
```


## Benefits and risks of COVID testing
```{r}
table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^test_pb|^test_pr"])
```

## Trust in COVID testing and vaccines
```{r}
table1(~ n_diagnostic_tests + n_tests_accurate + 
         n_tests_safe + n_serious_illness + n_hospitalized, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

```{r}
trust <- melt(DT[redcap_event_name == "baseline_interview_arm_2", 
   .(participant_id, n_diagnostic_tests, n_tests_accurate, n_tests_safe, n_serious_illness, n_hospitalized)],
   variable.name = "Item", value.name = "Response",
   id.vars = "participant_id")

trust[, Response_n := car::recode(Response, "'Disagree'=0;
                                  'Neither disagree nor agree'=1;
                                  'Agree'=2;
                                  else=NA", as.factor = FALSE, as.numeric = TRUE)]

trust_n <- dcast(trust[,.(participant_id, Item, Response_n)], 
      participant_id ~ Item, value.var = "Response_n")
```

### Reliability
```{r}
psych::alpha(trust_n[,-1])
```

### Summary Score
```{r}
trust_n <- merge(trust_n, trust[, .(Trust_Total = mean(Response_n, na.rm = TRUE)*5), by = .(participant_id)],
                 all.x = TRUE, all.y = TRUE)

label(trust_n$Trust_Total) <- "Trust in COVID testing and vaccines (0-10)"

table1(~ Trust_Total, data = trust_n)
```

## COVID Counter-Narratives
```{r}
table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^n_covid_cn"])
```

```{r}
counter <- melt(DT[redcap_event_name == "baseline_interview_arm_2", 
                   .SD, .SDcols = names(DT) %like% "participant_id|n_covid_cn\\d+$"],
                variable.name = "Item", value.name = "Response",
   id.vars = "participant_id")

counter[, Response_n := car::recode(Response, "'Disagree'=0;
                                  'Neither disagree nor agree'=1;
                                  'Agree'=2;
                                  else=NA", as.factor = FALSE, as.numeric = TRUE)]

counter_n <- dcast(counter[,.(participant_id, Item, Response_n)], 
      participant_id ~ Item, value.var = "Response_n")
```

### Reliability
```{r}
psych::alpha(counter_n[,-1])
```

### Summary Score
```{r}
counter_n <- merge(counter_n, counter[, .(Counter_Narratives_Total = mean(Response_n, na.rm = TRUE)*12), 
                                      by = .(participant_id)],
                 all.x = TRUE, all.y = TRUE)

label(counter_n$Counter_Narratives_Total) <- "COVID Counter-Narratives (0-24)"

table1(~ Counter_Narratives_Total, data = counter_n)
```

## In deciding whether to get the COVID-19 vaccine, how important are/were these statements to you?
```{r}
table1(~ vaccine_safe_2 + vaccine_effective_2 + vaccine_free_2 + 
         vaccine_no_pain_2 + vaccine_conven_2, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

## Alcohol and Tobacco/Nicotine Use
```{r}
DT[is.na(alcohol_daysperweek) & lifetime_use_alcohol == "No", alcohol_daysperweek := "Never"]

table1(~ lifetime_use_alcohol + alcohol_daysperweek + 
         smoker_cur_stat + smoker_number + vaper_cur_stat, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

## Barriers
```{r}
table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^n_perceived_barriers"])
```

## Behavioral intentions
```{r}
table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^n_behavioral"])
```

## Norms
**People who are important to me:**
```{r}
table1(~ n_social_norms_2 + social_norms_2 + social_norms_3, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

```{r}
snorms <- melt(DT[redcap_event_name == "baseline_interview_arm_2", 
                   .SD, .SDcols = names(DT) %like% "participant_id|social_norms"],
                variable.name = "Item", value.name = "Response",
   id.vars = "participant_id")

snorms[, Response_n := car::recode(Response, "
                                  'Strongly disagree'=0;
                                  'Disagree'=1;
                                  'Neither disagree nor agree'=2;
                                  'Agree'=3;
                                  'Strongly agree'=4;
                                  else=NA", as.factor = FALSE, as.numeric = TRUE)]

snorms_n <- dcast(snorms[,.(participant_id, Item, Response_n)], 
      participant_id ~ Item, value.var = "Response_n")
```

### Reliability
```{r}
psych::alpha(snorms_n[,-1])
```

### Summary Score
```{r}
snorms_n <- merge(snorms_n, snorms[, .(Social_Norms_Total = mean(Response_n, na.rm = TRUE)*3), 
                                      by = .(participant_id)],
                 all.x = TRUE, all.y = TRUE)

label(snorms_n$Social_Norms_Total) <- "COVID Testing Norms (0-12)"

table1(~ Social_Norms_Total, data = snorms_n)
```

## Altruism
```{r}
table1(~ n_altruism_1 + n_altruism_2, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

## Symptoms during the past week
```{r}

DT[, covid_abpain_2 := factor(covid_abpain_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_cough_2 := factor(covid_cough_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_diffbreath_2 := factor(covid_diffbreath_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_fatigue_2 := factor(covid_fatigue_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_fever_2 := factor(covid_fever_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_headache_2 := factor(covid_headache_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_myalgia_2 := factor(covid_myalgia_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_nausea_2 := factor(covid_nausea_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_olfactory_2 := factor(covid_olfactory_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_runnynose_2 := factor(covid_runnynose_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_skinrash_2 := factor(covid_skinrash_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]
DT[, covid_other_2 := factor(covid_other_2, levels = c(1,0,98,99), labels=c("Yes","No","Don't know","Prefer not to answer"))]

label(DT$covid_abpain_2) <- "Abdominal pain"
label(DT$covid_cough_2) <- "Cough"
label(DT$covid_diffbreath_2) <- "Shortness of breath or difficulty breathing"
label(DT$covid_fatigue_2) <- "Lack of energy or general tired feeling"
label(DT$covid_fever_2) <- "Fever or chills"
label(DT$covid_headache_2) <- "Headache"
label(DT$covid_myalgia_2) <- "Muscle or body aches"
label(DT$covid_nausea_2) <- "Feeling sick to your stomach or vomiting, diarrhea"
label(DT$covid_olfactory_2) <- "New loss of taste or smell"
label(DT$covid_runnynose_2) <- "Sore throat, congestion or runny nose"
label(DT$covid_skinrash_2) <-	"Skin Rash"
label(DT$covid_other_2) <- "Other symptoms"

table1(~ covid_abpain_2 + covid_cough_2 + covid_diffbreath_2 +
         covid_fatigue_2 + covid_fever_2 + covid_headache_2 +
         covid_myalgia_2 + covid_nausea_2 + covid_olfactory_2 +
         covid_runnynose_2 + covid_skinrash_2 + covid_other_2, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

## Health Status
```{r}
DT[, Inches := self_reported_height_feet*12 + self_reported_height_inches]
DT[, Centimeters := self_reported_height_meters*100 + self_reported_height_centimeters]
DT[is.na(Inches) & !is.na(Centimeters), Inches := Centimeters*0.3937007874]

DT[, Pounds := ifelse(!is.na(self_reported_weight_lbs), self_reported_weight_lbs,
                      ifelse(is.na(self_reported_weight_lbs) & 
                               !is.na(self_reported_weight_kgs), 
                             self_reported_weight_kgs*2.20462262185, NA))]

DT[, BMI := (Pounds / Inches / Inches) * 703]

label(DT$Inches) <- "Height in Inches"
label(DT$Inches) <- "Weight in Pounds"
label(DT$BMI) <- "Body Mass Index"
label(DT$self_reported_disability) <- "Do you have a disability that interferes with your ability to carry out daily activities?"

table1(~ Inches + Pounds + BMI + self_reported_disability + self_rpt_hlth_stat_asses, 
       data = DT[grepl("baseline_interview_arm_2", redcap_event_name)])
```

## Have you encountered any of the following barriers or problems with testing?
```{r}
covbarr <- names(DT)[grepl("^covid_barrier___", names(DT))]

DT[ , (covbarr) := lapply(.SD, function(x){factor(x, levels = c(0,1), labels = c('Unchecked','Checked'))}), .SDcols = covbarr]

label(DT$covid_barrier___1) <- "Need to take time to work to get tested"
label(DT$covid_barrier___2) <- "Out of pocket costs for test"
label(DT$covid_barrier___3) <- "Out of pocket costs for transportation, childcare, or time to work to get tested"
label(DT$covid_barrier___4) <- "I do not know where to go to be tested"
label(DT$covid_barrier___5) <- "Pain or discomfort from the test"
label(DT$covid_barrier___6) <- "Saliva"
label(DT$covid_barrier___7) <- "Concern about others handling my personal data"
label(DT$covid_barrier___8) <- "Other"
label(DT$covid_barrier___9) <- "None of the above"
label(DT$covid_barrier___98) <- "Don't know"
label(DT$covid_barrier___99) <- "Prefer not to answer"

table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^covid_barr"])
```

## If you needed to isolate due to a positive test or illness, what challenges do you face?
```{r}
covisol <- names(DT)[grepl("^covid_iso_chal___", names(DT))]

DT[ , (covisol) := lapply(.SD, function(x){factor(x, levels = c(0,1), labels = c('Unchecked','Checked'))}), .SDcols = covisol]

label(DT$covid_iso_chal___1) <- "There are other people in my household"  
label(DT$covid_iso_chal___2) <- "There are children in my household" 
label(DT$covid_iso_chal___3) <- "There are older adults in my household"  
label(DT$covid_iso_chal___4) <- "I don't have a good place where I could isolate"  
label(DT$covid_iso_chal___5) <- "No one to help me if I am sick" 
label(DT$covid_iso_chal___6) <- "Lost income or wages"  
label(DT$covid_iso_chal___7) <- "People might blame me or treat me badly" 
label(DT$covid_iso_chal___8) <- "Other" 
label(DT$covid_iso_chal___9) <- "None of the above"
label(DT$covid_iso_chal___98) <- "Don't know"
label(DT$covid_iso_chal___99) <- "Prefer not to answer"

table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^covid_iso"])
```

## Does your employer offer paid time off if you test positive?
```{r}
table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^covid_pto"])
```

## In the past week, how worried have you been about coronavirus (COVID-19)?
```{r}
table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^pastweek_worriedself"])
```

## If you would be exposed to someone with COVID-19, would you be able to quarantine without losing your job?
```{r}
table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^quarantine_maintain_job"])
```

## If I get a negative test result, it means
```{r}
testresneg <- names(DT)[grepl("^test_resneg_2___", names(DT))]

DT[ , (testresneg) := lapply(.SD, function(x){factor(x, levels = c(0,1), labels = c('Unchecked','Checked'))}), .SDcols = testresneg]

label(DT$test_resneg_2___1) <- "I don't have to worry about getting COVID-19" 
label(DT$test_resneg_2___2) <- "I don't have COVID-19 now"
label(DT$test_resneg_2___3) <- "I can be around others without giving the virus to them"
label(DT$test_resneg_2___4) <- "I can be around others without getting the virus from them" 
label(DT$test_resneg_2___99) <- "Prefer not to answer"

table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^test_resneg_2"])
```

## If I get a positive result, it means
```{r}
testrespos <- names(DT)[grepl("^test_respos_2___", names(DT))]

DT[ , (testrespos) := lapply(.SD, function(x){factor(x, levels = c(0,1), labels = c('Unchecked','Checked'))}), .SDcols = testrespos]

label(DT$test_respos_2___1) <- "I will need to be admitted to the hospital"
label(DT$test_respos_2___2) <- "I will need to isolate myself from others" 
label(DT$test_respos_2___3) <- "I will need to take off work"
label(DT$test_respos_2___99) <- "Prefer not to answer"

table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^test_respos_2"])
```

## Why would you NOT get a COVID-19 vaccine?
```{r}
vaccon <- names(DT)[grepl("^vaccine_concerns_3___", names(DT))]

DT[ , (vaccon) := lapply(.SD, function(x){factor(x, levels = c(0,1), labels = c('Unchecked','Checked'))}), .SDcols = vaccon]

label(DT$vaccine_concerns_3___1) <- "I'm allergic to vaccines"
label(DT$vaccine_concerns_3___2) <- "I don't like needles"
label(DT$vaccine_concerns_3___3) <- "I'm not concerned about getting really sick from COVID-19"
label(DT$vaccine_concerns_3___4) <- "I'm concerned about side effects from the vaccine"
label(DT$vaccine_concerns_3___5) <- "I don't think vaccines work very well"
label(DT$vaccine_concerns_3___6) <- "I don't trust that the vaccine will be safe"
label(DT$vaccine_concerns_3___7) <- "I don't believe the COVID- 19 pandemic is as bad as some people say it is"
label(DT$vaccine_concerns_3___8) <- "I don't want to pay for it"
label(DT$vaccine_concerns_3___9) <- "I don't know enough about how well a COVID-19 vaccine works"
label(DT$vaccine_concerns_3___10) <- "Other"
label(DT$vaccine_concerns_3___96) <- "Not Applicable"
label(DT$vaccine_concerns_3___99) <- "Prefer not to answer"

table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^vaccine_concerns_3"])
```

## Why would you get a COVID-19 vaccine?
```{r}
vacreas <- names(DT)[grepl("^vaccine_reasons_3___", names(DT))]

DT[ , (vacreas) := lapply(.SD, function(x){factor(x, levels = c(0,1), labels = c('Unchecked','Checked'))}), .SDcols = vacreas]

label(DT$vaccine_reasons_3___1) <- "I want to keep my family safe"
label(DT$vaccine_reasons_3___2) <- "I want to keep my community safe"
label(DT$vaccine_reasons_3___3) <- "I want to keep myself safe"
label(DT$vaccine_reasons_3___4) <- "I have a chronic health problem, like asthma or diabetes"
label(DT$vaccine_reasons_3___5) <- "My doctor told me to get a COVID-19 vaccine"
label(DT$vaccine_reasons_3___6) <- "I don't want to get really sick from COVID-19"
label(DT$vaccine_reasons_3___7) <- "I want to feel safe around other people"
label(DT$vaccine_reasons_3___8) <- "I believe life won't go back to normal until most people get a COVID-19 vaccine"
label(DT$vaccine_reasons_3___10) <- "Required by my school or workplace"
label(DT$vaccine_reasons_3___11) <- "Required for travel"
label(DT$vaccine_reasons_3___9) <- "Other"
label(DT$vaccine_reasons_3___96) <- "Not Applicable"
label(DT$vaccine_reasons_3___99) <- "Prefer not to answer"

table1(~ ., data = DT[grepl("baseline_interview_arm_2", redcap_event_name), 
                      .SD, .SDcols = names(DT) %like% "^vaccine_reasons_3"])
```

```{r, eval=FALSE}
rcon <- redcapAPI::redcapConnection(url = 'https://redcap.nyu.edu/api/', token=token)

redcapAPI::exportEvents(rcon)
redcapAPI::fieldChoiceMapping(object = rcon, field_name = "covid_barrier")

exportRecords(rcon, events = "baseline_interview_arm_2", forms = "baseline",
              factors = TRUE,
              checkboxLabels = FALSE)

fieldChoiceMapping(object = rcon, field_name = "language_home")
fieldChoiceMapping(object = rcon, field_name = "vaccine_reasons_3")

url <- "https://redcap.nyu.edu/api/"

formData <- list("token"=token,
    content='record',
    action='export',
    format='csv',
    type='flat',
    csvDelimiter='',
    'fields[0]'='quarantine_maintain_job',
    'forms[0]'='baseline',
    rawOrLabel='label',
    rawOrLabelHeaders='label',
    exportCheckboxLabel='true',
    exportSurveyFields='false',
    exportDataAccessGroups='false',
    returnFormat='csv'
)
response <- httr::POST(url, body = formData, encode = "form")
result <- httr::content(response)
print(result)

```


# Randomization
```{r}
table1(~ rand_condition, data = DT[redcap_event_name == "randomization_arm_2",])
```

```{r}
DT[, MI_Component := rand_condition %in% c('Bear','Cat','Fish','Giraffe','Jaguar','Lion','Rabbit','Snake')]

DT[, Peer_Component := rand_condition %in% c('Bear','Cat','Dog','Elephant','Fish','Giraffe','Hyena','Iguana')]

DT[, TMQQ_Component := rand_condition %in% 
c('Bear','Cat','Dog','Elephant','Jaguar','Lion','Octopus','Panda')]

DT[, Access_Component := ifelse(rand_condition %in%
c('Bear','Dog','Fish','Hyena','Jaguar','Octopus','Rabbit','Tiger'), "Navigation", "Self-Test")]
```

## By Component
```{r}
table1(~ MI_Component + Peer_Component + TMQQ_Component + Access_Component, 
       data = DT[redcap_event_name == "randomization_arm_2",])
```

```{r}
fullfact <- DT[redcap_event_name == "randomization_arm_2", .(rand_condition, MI_Component, Peer_Component, TMQQ_Component, Access_Component)] |> unique()

kbl(fullfact[order(rand_condition)], 
    booktabs = T, escape = F, align = "c") %>%
  kable_paper("hover", full_width = FALSE)
```


# Core Component
```{r}
label(DT$np_core_timespent) <- "Number of minutes spent on Core activities"

table1(~ np_core_timespent + intro_to_project + info_about_testing + testing_circumstances + 
  thoughts_on_testing + transmission_positive_test + what_to_do +
  test_to_treat + referrals, data = DT[grepl("^core", redcap_event_name),])
```

# MI Component
```{r}
table1(~ introduction + engage_and_orient + covid_is_not_over + focus_on_testing +
  readiness_for_testing + mythbusters + focus_on_vaccination, 
  data = DT[grepl("^a_mi_counseling", redcap_event_name),])

```

# TMQQ Component
```{r}

label(DT$tmqq1) <- "Regular COVID-19 testing is recommended for people who are not fully vaccinated."
label(DT$tmqq2) <- "COVID-19 testing is quick, easy, and available for free at hundreds of locations without an appointment."
label(DT$tmqq3) <- "You cannot test for COVID-19 in the privacy of your own home."
label(DT$tmqq4) <- "You should stay home for at least 5 days if you test positive for COVID-19."
label(DT$tmqq5) <- "You need to pay to get tested for COVID-19 at NYC Health + Hospitals."
label(DT$tmqq6) <- "COVID-19 is caused by the same virus as the flu."
label(DT$tmqq7) <- "Children cannot get COVID-19."
label(DT$tmqq8) <- "Getting tested for COVID is quick and painless."
label(DT$tmqq9) <- "Getting tested for COVID-19 regularly is an important way to find that you have COVID-19 as early as possible."
label(DT$tmqq10) <- "Wearing a mask can help stop the spread of COVID-19."
label(DT$tmqq11) <- "People who show symptoms of COVID-19 infection should NOT get tested."
label(DT$tmqq12) <- "Getting tested regularly does not help stop the spread of COVID."

table1(~ tmqq1 + tmqq2 + tmqq3 + tmqq4 + tmqq5 + tmqq6 +
         tmqq7 + tmqq8 + tmqq9 + tmqq10 + tmqq11 + tmqq12 + tmqq_points, 
       data = DT[grepl("b_tmqqs", redcap_event_name),])
```

# Peer Component

```{r}
PC <- REDCapR::redcap_read(redcap_uri=uri, raw_or_label = "raw", token=tkns[2,2])$data
PC_n <- REDCapR::redcap_read(redcap_uri=uri, raw_or_label = "raw", token=tkns[2,2])$data

meta_PC <- redcap_metadata_read(redcap_uri = uri, token=tkns[2,2])$data
names(meta_PC)[1:6] <- c("var","form","header","type","label","choices")
setDT(meta_PC)

meta_PC[!is.na(choices), choices := paste(gsub(";", ",", choices))]
meta_PC[!is.na(choices), choices := paste(gsub("Don't", "Do not", choices))]
meta_PC[!is.na(choices), choices := paste(gsub("0, No\\|1, Yes\\|997, Do not Know", "0, No \\| 1, Yes \\| 997, Do not Know", choices))]
meta_PC[!is.na(choices), choices := paste(gsub("0, No\\| 1, Yes", "0, No \\| 1, Yes", choices))]
meta_PC[!is.na(choices), choices := paste(gsub("1, Not at all \\| 2, A little\\|3, Somewhat \\|4, Quite a bit \\|5, A great deal  \\|997, Do not Know \\| 998, Refuse to Answer",
                                               "1, Not at all \\| 2, A little \\| 3, Somewhat \\| 4, Quite a bit \\| 5, A great deal \\| 997, Do not Know \\| 998, Refuse to Answer", choices))]
meta_PC[!is.na(choices), choices := paste(gsub("2,  \\||4,  \\|", "", choices))]
meta_PC[!is.na(choices), factlab := paste(gsub(" \\| ", "';", gsub("([0-9]), ", "\\1='", gsub("'", "", choices))), "'", sep = "")]
meta_PC[!is.na(label), attriblab := gsub("\n", "", label)]
meta_PC[!is.na(attriblab), attriblab := gsub("<[^>]*>", "", attriblab)]

meta_PC[!is.na(choices), factlab := gsub("<.*?>", "", factlab)]
meta_PC[!is.na(attriblab), attriblab := gsub("<.*?>", "", attriblab)]


val_labs <- intersect(meta_PC$var[!is.na(meta_PC$choices)], names(PC))

vlabmatch <- data.frame(var = val_labs, 
                        PC_index = match(val_labs, names(PC)),
                        ddict_index = match(val_labs, meta_PC$var))

vlabmatch$factlab <- meta_PC$factlab[vlabmatch$ddict_index]

for(i in 1:length(val_labs)){
PC[,vlabmatch$PC_index[i]] <- car::recode(var = PC[,vlabmatch$PC_index[i]], 
                                                recodes = vlabmatch$factlab[i],
                                                levels = strsplit(x = gsub("\\d+=|'", "", vlabmatch$factlab[i]), split = ";")[[1]],
                                                as.factor = TRUE)
}

## Apply Variables Labels
var_labs <- intersect(meta_PC$var[!is.na(meta_PC$attriblab)], names(PC))

alabmatch <- data.frame(var = var_labs,
                        PC_index = match(var_labs, names(PC)),
                        ddict_index = match(var_labs, meta_PC$var))

alabmatch$fieldlabel <- meta_PC$attriblab[alabmatch$ddict_index]

for(i in 1:length(var_labs)){
attributes(PC[, alabmatch$PC_index[i]])$label <- alabmatch$fieldlabel[i]  
}

setDT(PC)

PC[, coupon := toupper(coupon)]
PC[coupon == "DCR031394_002", coupon := "DACR031394_002"]
PC[coupon == "DCR031394_003", coupon := "DACR031394_003"]
PC[coupon == "TIST.012492_003", coupon := "TIST012492_003"]
PC[coupon == "LIBR0801_001", coupon := "LIBR080166_001"]
PC[coupon == "ROW1021063001", coupon := "ROW1021063_001"]
PC[coupon == "ESU110795_001", coupon := "ESUW110795_001"]
PC[coupon == "050579001", coupon := "NIIN050579_001"]
PC[coupon == "NIINO050579_002", coupon := "NIIN050579_002"]
PC[coupon == "NINI050579_003", coupon := "NIIN050579_003"]
PC[coupon == "AUGL02098-003", coupon := "AUGL020298_003"]
PC[coupon == "AUGL02098-001", coupon := "AUGL020298_001"]
PC[coupon == "JOOR20589_002", coupon := "JOOR120589_002"]

# PC[peer_age >= 18 & peer_age <= 70 & peer_language == 1 & peer_residence == 1 & peer_enrollment == 0, .(coupon)]

PC[, Eligible := peer_age >= 18 & peer_age <= 70 & peer_language == "Yes" & peer_residence == "Yes" & peer_enrollment == "No"]
```

* n=`r nrow(unique(PC[Eligible == TRUE, .(coupon)]))` non-duplicated coupons redeemed by eligible peers
* n=`r nrow(PC) - 3 - nrow(unique(PC[Eligible == TRUE, .(coupon)]))` ineligible, incomplete, or duplicate coupons

```{r, results='hide'}
pcomp <- DT[redcap_event_name == "randomization_arm_2", 
            .(participant_id, rand_condition)]

pcomp[, Peer_Component := rand_condition %in% c('Bear','Cat','Dog','Elephant','Fish','Giraffe','Hyena','Iguana')]

PC[, participant_id := substr(coupon, 1, 10)]

PC[, .(ncoupons = .N), by = .(participant_id)]

pcomp <- merge(pcomp, PC[Eligible == TRUE, .(ncoupons = length(unique(coupon))), 
                         by = .(participant_id)], all.x = TRUE, all.y = FALSE)

pcomp <- pcomp[Peer_Component == TRUE,]
pcomp[, ncoupons := car::recode(ncoupons, "NA=0")]
pcomp[, coupons_cat := factor(ncoupons)]
pcomp[, Any_Peer := car::recode(ncoupons, "0='No';1:hi='Yes'")]

label(pcomp$ncoupons) <- "Number of Eligible Peers"
label(pcomp$coupons_cat) <- "Number of Eligible Peers (Categorical)"
label(pcomp$Any_Peer) <- "Any Eligible Peers"
```

## Eligible Peers among Participants Assigned to Peer Component
```{r}
table1(~ ncoupons + coupons_cat + Any_Peer, data = pcomp)
```

<br>

## Peer Characteristics

```{r}
table1(~ peer_age + peer_language + peer_residence + peer_enrollment, data = PC[!is.na(peer_age)])
```

<br>

```{r}
table1(~ peer_bio_sex_birth_2 + peer_race_hispanic + peer_relationship + peer_covid_vaccine +
         peer_fully_vax + peer_tested + peer_gen_knowledge + peer_learn + peer_intent + 
         peer_intent_future + peer_work_status, 
       data = PC[Eligible == TRUE,])
```

## Peer COVID Knowledge
```{r}
PC[, peer_tf1 := car::recode(peer_tf1, "0='FALSE';1='TRUE'", as.factor = TRUE)]
PC[, peer_tf2 := car::recode(peer_tf2, "0='FALSE';1='TRUE'", as.factor = TRUE)]
PC[, peer_tf3 := car::recode(peer_tf3, "0='FALSE';1='TRUE'", as.factor = TRUE)]
PC[, peer_tf4 := car::recode(peer_tf4, "0='FALSE';1='TRUE'", as.factor = TRUE)]
PC[, peer_tf5 := car::recode(peer_tf5, "0='FALSE';1='TRUE'", as.factor = TRUE)]
PC[, peer_tf6 := car::recode(peer_tf6, "0='FALSE';1='TRUE'", as.factor = TRUE)]
PC[, peer_tf7 := car::recode(peer_tf7, "0='FALSE';1='TRUE'", as.factor = TRUE)]
PC[, peer_tf8 := car::recode(peer_tf8, "0='FALSE';1='TRUE'", as.factor = TRUE)]
PC[, peer_tf9 := car::recode(peer_tf9, "0='FALSE';1='TRUE'", as.factor = TRUE)]
PC[, peer_tf10 := car::recode(peer_tf10, "0='FALSE';1='TRUE'", as.factor = TRUE)]

label(PC$peer_tf1) <- 'COVID testing is no longer needed to fight the COVID epidemic.'
label(PC$peer_tf2) <- 'The only time I need to get tested for COVID is when I am exhibiting serious health symptoms.' 
label(PC$peer_tf3) <- 'COVID testing is quick, easy, and available for free at hundreds of locations without an appointment.' 
label(PC$peer_tf4) <- 'Getting tested for COVID regularly is an important tool to protect yourself and your community.'
label(PC$peer_tf5) <- 'Regular COVID testing is especially important for people at highest risk for exposure to COVID such as frontline and essential workers.' 
label(PC$peer_tf6) <- 'Experts recommend people who are not fully vaccinated for COVID get tested regularly to help stop the spread.' 
label(PC$peer_tf7) <- 'There is only one way to get tested for COVID and that is by going to a hospital.'
label(PC$peer_tf8) <- 'Millions of African Americans and Black and Latino essential and frontline workers have been tested for COVID.' 
label(PC$peer_tf9) <- 'I DO NOT need to be tested for COVID if I think I have come into contact with someone who has COVID.' 
label(PC$peer_tf10) <- 'If I test positive for COVID, I should NOT tell my health care provider.' 

table1(~ ., data = PC[Eligible == TRUE, .SD, .SDcols = names(PC) %like% "^peer_tf"])
```

```{r, eval=FALSE}
DT[nchar(np_pe_staff) > 4, np_pe_staff := NA]

# table1(~ ., data = DT[grepl("c_peer", redcap_event_name),
#                       .SD, .SDcols = names(DT) %like% "^peer"])

table1(~ np_pe_staff, data = DT[grepl("c_peer", redcap_event_name)])
```

# Navigation Component
```{r}
DT[, np_ai_method := car::recode(np_ai_method, "1='Navigation';2='Self-test';else=NA", as.factor = TRUE, levels = c('Navigation','Self-test'))]
label(DT$np_ai_method) <- "Access Intervention method"

table1(~ np_ai_method, data = DT[grepl("^d_access", redcap_event_name)])
```

```{r, eval=FALSE}
DT_id <- data.frame(pid = unique(DT$participant_id))
setDT(DT_id)

DT_id[, Screeening_Consent := pid %in% DT$participant_id[DT$redcap_event_name == "screener_consent_arm_1"]]
DT_id[, Screeening_Main := pid %in% DT$participant_id[DT$redcap_event_name == "screener_arm_1"]]
DT_id[, Enroll_Consent := pid %in% DT$participant_id[DT$redcap_event_name == "consent_form_arm_2"]]
DT_id[, Baseline := pid %in% DT$participant_id[DT$redcap_event_name == "baseline_interview_arm_2"]]
DT_id[, Randomized := pid %in% DT$participant_id[DT$redcap_event_name == "randomization_arm_2"]]
```


# Follow-Up
## Completion
```{r}
DT[redcap_event_name == "baseline_interview_arm_2", Days_Since_BL := as.numeric(difftime(Sys.Date(), bl_date, units = "days"))]

FUrate <- DT[redcap_event_name == "baseline_interview_arm_2", .(participant_id, bl_date, Days_Since_BL)]

FUrate <- merge(FUrate, DT[redcap_event_name == "followup_interview_arm_2", .(participant_id, FU1 = followup_interview_1_6weeks_complete, fu1_date)],
                all = TRUE)

FUrate <- merge(FUrate, DT[redcap_event_name == "followup_interview_arm_2b", .(participant_id, FU2 = followup_interview_2_12weeks_c6e6_complete, fu2_date = fu1_date_fu2)],
                all = TRUE)

FUrate[, FU1 := car::recode(FU1, "2='Yes';else='No'", as.factor = TRUE)]
FUrate[, FU2 := car::recode(FU2, "2='Yes';else='No'", as.factor = TRUE)]

FUrate[, FU1_Completion := factor(ifelse(FU1 == "Yes", "Completed", 
                                         ifelse(Days_Since_BL > 57, "Follow-Up One Missed", NA)))]

FUrate[, FU2_Completion := factor(ifelse(FU2 == "Yes", "Completed",
                              ifelse(Days_Since_BL > 112, "Follow-Up Two Missed", NA)))]

label(FUrate$FU1_Completion) <- "First Follow-Up Completion"
label(FUrate$FU2_Completion) <- "Second Follow-Up Completion"
```

### Six Weeks
```{r}
table1(~ FU1_Completion, data = FUrate[!is.na(FU1_Completion),])
```

* n=`r nrow(FUrate[is.na(FU1_Completion)])` interviews pending

### Twelve Weeks
```{r}
table1(~ FU2_Completion, data = FUrate[!is.na(FU2_Completion),])
```

* n=`r nrow(FUrate[is.na(FU2_Completion)])` interviews pending

## Testing and vaccination
### Six Weeks
```{r}
label(DT$fu1_q1) <- "In this recent period, have you been tested for COVID-19 at least once?"
label(DT$fu1_q2) <- "How many times did you get tested or test yourself for COVID-19?"

table1(~ fu1_q1 + fu1_q2 + fu1_q26, 
       data = DT[redcap_event_name == "followup_interview_arm_2"])
```

### Twelve Weeks
```{r}
label(DT$fu1_q1_fu2) <- "In this recent period, have you been tested for COVID-19 at least once?"
label(DT$fu1_q2_fu2) <- "How many times did you get tested or test yourself for COVID-19?"

table1(~ fu1_q1_fu2 + fu1_q2_fu2 + fu1_q26_fu2, 
       data = DT[redcap_event_name == "followup_interview_arm_2b"])
```

# PHS Categories
```{r}
DT[redcap_event_name == "screener_arm_1", Hispanic := car::recode(race_ethn_hispanic, "'No, not of Hispanic, Latino, or Spanish origin'='Not Hispanic or Latino';'Yes, of Hispanic, Latino, or Spanish origin'='Hispanic or Latino';else='Unknown/Not Reported Ethnicity'", as.factor = TRUE)]
DT[, Hispanic := ordered(Hispanic, levels = c('Not Hispanic or Latino','Hispanic or Latino','Unknown/Not Reported Ethnicity'))]

DT[redcap_event_name == "screener_arm_1", Racecheck := rowSums(.SD == 1), .SDcols = names(DT) %like% "^race_ethn_race___[1-5]|^race_ethn_race___15"]
DT[redcap_event_name == "screener_arm_1", Raceunknown := rowSums(.SD == 0), .SDcols = names(DT) %like% "^race_ethn_race___[1-5]"]
DT[redcap_event_name == "screener_arm_1", Multirace := Racecheck > 1 | race_ethn_race___15 == 1]

DT[, PHS_cat := case_when(
                    race_ethn_race___1 == 1 & !Multirace ~ 'American Indian/Alaska Native',
                    race_ethn_race___3 == 1 & !Multirace ~ 'Asian',
                    race_ethn_race___2 == 1 & !Multirace ~ 'Black or African American',
                    race_ethn_race___4 == 1 & !Multirace ~ 'Native Hawaiian or Other Pacific Islander',
                    race_ethn_race___5 == 1 & !Multirace ~ 'White',
                    Multirace ~ 'More than One Race',
                    Raceunknown == 5 ~ 'Unknown or Not Reported')]

DT[, PHS_cat := car::recode(PHS_cat, "NA='Unknown or Not Reported'")]

DT[, PHS_cat := ordered(PHS_cat, levels = c('American Indian/Alaska Native',
                                             'Asian',
                                             'Native Hawaiian or Other Pacific Islander',
                                             'Black or African American',
                                             'White',
                                             'More than One Race',
                                             'Unknown or Not Reported'))]

label(DT$PHS_cat) <- "PHS Race Category"
label(DT$Hispanic) <- "Ethnic Categories"

demog <- merge(DT[redcap_event_name == "screener_arm_1", .(participant_id, Hispanic, PHS_cat, age_yrs)],
               DT[redcap_event_name == "baseline_interview_arm_2" & !is.na(bl_date), .(participant_id, bl_date, sex_Birth)], all = TRUE)

demog[, Enrolled := participant_id %in% Enrolled]
demog[, sex_Birth := car::recode(sex_Birth, "NA='Missing/Unknown'", as.factor = TRUE, levels = c("Female","Male","Missing/Unknown"))]
```

## All Screened
```{r, results='asis'}
mytab1 <- gtsummary::tbl_cross(demog, row = PHS_cat, col = Hispanic)
print(mytab1)
```

<br>

```{r}
with(demog, 
     table(PHS_cat, Ethnicity = Hispanic)) %>% 
  as.data.frame() %>%
  subset(Freq > 0) %>%
  kbl(row.names = FALSE, col.names = c("PHS Category","Ethnicity","Frequency")) %>%
  kable_paper("hover", full_width = F)
```

* Sex assigned at birth was only asked of enrolled participants

## Only Enrolled
```{r, results='asis'}
mytab2 <- gtsummary::tbl_cross(demog[Enrolled == TRUE & !is.na(bl_date)], row = PHS_cat, col = Hispanic)
print(mytab2)
```

<br>

```{r}
with(demog[Enrolled == TRUE & !is.na(bl_date)], 
     table(PHS_cat, Hispanic, sex_Birth)) %>% 
  as.data.frame() %>%
  subset(Freq > 0) %>%
  kbl(row.names = FALSE, col.names = c("PHS Category","Ethnicity","Assigned Sex at Birth","Frequency")) %>%
  kable_paper("hover", full_width = F)
```

```{r, eval=FALSE}
write.xlsx(demog[Enrolled == TRUE,][order(PHS_cat, Hispanic, sex_Birth, age_yrs),
                                    .(participant_id, PHS_cat, Hispanic, sex_Birth, age_yrs, bl_date)],
           "plist.xlsx", overwrite = TRUE)
```

```{r}
PC[, Hispanic := car::recode(peer_race_hispanic, "'No, not of Hispanic, Latino, or Spanish origin'='Not Hispanic or Latino';'Yes, of Hispanic, Latino, or Spanish origin'='Hispanic or Latino';else='Unknown/Not Reported Ethnicity'", as.factor = TRUE)]
PC[, Hispanic := ordered(Hispanic, levels = c('Not Hispanic or Latino','Hispanic or Latino','Unknown/Not Reported Ethnicity'))]

PC[, Racecheck := rowSums(.SD == 1), .SDcols = names(PC) %like% "^peer_race_ethn_race___[1-5]|^peer_race_ethn_race___15"]
PC[, Raceunknown := rowSums(.SD == 0), .SDcols = names(PC) %like% "^peer_race_ethn_race___[1-5]"]
PC[, Multirace := Racecheck > 1 | peer_race_ethn_race___15 == 1]

PC[, PHS_cat := case_when(
                    peer_race_ethn_race___1 == 1 & !Multirace ~ 'American Indian/Alaska Native',
                    peer_race_ethn_race___3 == 1 & !Multirace ~ 'Asian',
                    peer_race_ethn_race___2 == 1 & !Multirace ~ 'Black or African American',
                    peer_race_ethn_race___4 == 1 & !Multirace ~ 'Native Hawaiian or Other Pacific Islander',
                    peer_race_ethn_race___5 == 1 & !Multirace ~ 'White',
                    Multirace ~ 'More than One Race',
                    Raceunknown == 5 ~ 'Unknown or Not Reported')]

PC[, PHS_cat := car::recode(PHS_cat, "NA='Unknown or Not Reported'")]

PC[, PHS_cat := ordered(PHS_cat, levels = c('American Indian/Alaska Native',
                                             'Asian',
                                             'Native Hawaiian or Other Pacific Islander',
                                             'Black or African American',
                                             'White',
                                             'More than One Race',
                                             'Unknown or Not Reported'))]

label(PC$PHS_cat) <- "PHS Race Category"
label(PC$Hispanic) <- "Ethnic Categories"

PC_demog <- PC[, .(record_id, coupon, peer_consent, peer_date, Hispanic, PHS_cat, peer_age, peer_bio_sex_birth_2)]
PC_demog[, sex_Birth := car::recode(peer_bio_sex_birth_2, "NA='Missing/Unknown';'None of these describe me'='Missing/Unknown'", as.factor = TRUE, levels = c("Female","Male","Missing/Unknown"))]
```

```{r, eval=FALSE}
write.xlsx(PC_demog[!is.na(peer_consent) & peer_consent == 1], "peerlist.xlsx", overwrite = TRUE)
```


```{r}
# No Consent

noconsent <- as.vector(
  na.omit(DT$participant_id[DT$did_participant_consent == 0])
  )
```

```{r}
# Missing Consent Date

missing_consent_date <- DT$participant_id[DT$redcap_event_name == "screener_arm_1" & 
                                         is.na(DT$consentdt_mdy)]
```


```{r}
# Check for Inconsistent ID Numbers 

All_ID <- data.frame(ID = unique(DT$participant_id))

setDT(All_ID)

All_ID[, Screener_Consent := ID %in% DT[redcap_event_name == "screener_consent_arm_1",]$participant_id]
All_ID[, Screening := ID %in% DT[redcap_event_name == "screener_arm_1",]$participant_id]
All_ID[, Baseline := ID %in% DT[redcap_event_name == "baseline_interview_arm_2",]$participant_id]
All_ID[, FollowOne := ID %in% DT[redcap_event_name == "followup_interview_arm_2",]$participant_id]
All_ID[, FollowTwo := ID %in% DT[redcap_event_name == "followup_interview_arm_2b",]$participant_id]
All_ID[, NoConsent := ID %in% noconsent]
All_ID[, Missing_Consent_Date := ID %in% missing_consent_date]
All_ID[, Bad_Format := nchar(ID) != 10]
```

```{r}
with(All_ID[Screening == TRUE &
            Bad_Format == FALSE &
            NoConsent == FALSE &
            Missing_Consent_Date == FALSE], 
     table(Screening, Baseline, FollowOne, FollowTwo)) |> 
  as.data.frame() |> 
  subset(Freq > 0) |> 
  kbl(booktabs = T, escape = FALSE) %>%
kable_styling(full_width = F, latex_options = c("striped", "HOLD_position"))
```


```{r}
# Excluded Records

write.xlsx(All_ID[!(Bad_Format == FALSE &
            NoConsent == FALSE &
            Missing_Consent_Date == FALSE)],
           "c:/Dbox/NCAP Data/Excluded.xlsx", overwrite = TRUE)

DT <- DT[!(participant_id %in% All_ID[!(Bad_Format == FALSE &
                                        NoConsent == FALSE &
                                        Missing_Consent_Date == FALSE)]$ID),]
```

```{r}
DT[, consent_ident := 0]  # Consent_ident = hardcode ‘0’ for all participants
DT[, consent_zip_2 := 1]  # consent_zip_2 = hardcode ‘1’ for all participants
```

```{r}
DT[, housing_employment_and_insurance_complete := NULL]  
DT[, randomization_check_form_complete := NULL]            
DT[, component_c_peer_education_complete := NULL]         
DT[, component_c_peer_interview_complete := NULL]          
DT[, component_d_access_intervention_complete := NULL]     
DT[, followup_interview_1_6weeks_complete := NULL]        
DT[, followup_interview_2_12weeks_c6e6_complete := NULL]  

# Checklist variables by redcap event
checklist_vars <- c("participant_id", "redcap_event_name", names(DT)[grep("___", names(DT))])

checklist_melt <- melt(DT[, .SD, .SDcols = checklist_vars], id.vars = c("participant_id","redcap_event_name"))

checkl_scrn <- as.character(checklist_melt[,.(any(!is.na(value))), 
                            by = .(redcap_event_name, variable)][V1 == TRUE & redcap_event_name == "screener_arm_1",]$variable)

checkl_loc <- as.character(checklist_melt[,.(any(!is.na(value))), 
                            by = .(redcap_event_name, variable)][V1 == TRUE & redcap_event_name == "locator_form_arm_2",]$variable)

checkl_bl <- as.character(checklist_melt[,.(any(!is.na(value))), 
                            by = .(redcap_event_name, variable)][V1 == TRUE & redcap_event_name == "baseline_interview_arm_2",]$variable)

checkl_fu1 <- as.character(checklist_melt[,.(any(!is.na(value))), 
                            by = .(redcap_event_name, variable)][V1 == TRUE & redcap_event_name == "followup_interview_arm_2",]$variable)

checkl_fu2 <- as.character(checklist_melt[,.(any(!is.na(value))), 
                            by = .(redcap_event_name, variable)][V1 == TRUE & redcap_event_name == "followup_interview_arm_2b",]$variable)

scon_vars <- c("participant_id","scr_consent_date1","scr_consent_obtain","scr_consent_date2") # exclude participant name
scrn_vars <- intersect(names(DT), c("participant_id", meta_DT[form == "screening",]$var, checkl_scrn))
scrn_vars <- setdiff(scrn_vars, "n_mailing_address") # exclude mailing address
cform_vars <- intersect(names(DT), c("participant_id", meta_DT[form == "consent_form",]$var))
loc_vars <- intersect(names(DT), c("participant_id", meta_DT[form == "locator_form",]$var))
bl_vars <- intersect(names(DT), c("participant_id", meta_DT[form == "baseline",]$var, checkl_bl))
fu1_vars <- intersect(names(DT), c("participant_id", meta_DT[form == "followup_interview_1_6weeks",]$var, checkl_fu1))
fu2_vars <- intersect(names(DT), c("participant_id", meta_DT[form == "followup_interview_2_12weeks_c6e6",]$var, checkl_fu2))

extra_vars <- setdiff(names(DT), c(scon_vars, scrn_vars, cform_vars,
                                   loc_vars, bl_vars,
                                   fu1_vars, fu2_vars, checklist_vars,
                                   "n_mailing_address", "scr_consent_name")) 

# DT[redcap_event_name == "screener_consent_arm_1", .SD, .SDcols = scon_vars]
# DT[redcap_event_name == "screener_arm_1", .SD, .SDcols = scrn_vars]
# DT[redcap_event_name == "consent_form_arm_2", .SD, .SDcols = cform_vars]
# DT[redcap_event_name == "locator_form_arm_2", .SD, .SDcols = loc_vars]
# DT[redcap_event_name == "baseline_interview_arm_2", .SD, .SDcols = bl_vars]
# DT[redcap_event_name == "followup_interview_arm_2", .SD, .SDcols = fu1_vars]
# DT[redcap_event_name == "followup_interview_arm_2b", .SD, .SDcols = fu2_vars]

# SPSS
haven::write_sav(DT[redcap_event_name == "screener_consent_arm_1", .SD, .SDcols = scon_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/SPSS/NCAP-Screener-Consent.sav")

haven::write_sav(DT[redcap_event_name == "screener_arm_1", .SD, .SDcols = scrn_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/SPSS/NCAP-Screening.sav")

haven::write_sav(DT[redcap_event_name == "baseline_interview_arm_2", .SD, .SDcols = bl_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/SPSS/NCAP-Baseline.sav")

haven::write_sav(DT[redcap_event_name == "followup_interview_arm_2", .SD, .SDcols = fu1_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/SPSS/NCAP-Follow1.sav")

haven::write_sav(DT[redcap_event_name == "followup_interview_arm_2b", .SD, .SDcols = fu2_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/SPSS/NCAP-Follow2.sav")

# Stata
haven::write_dta(DT[redcap_event_name == "screener_consent_arm_1", .SD, .SDcols = scon_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/Stata/NCAP-Screener-Consent.dta")

haven::write_dta(DT[redcap_event_name == "screener_arm_1", .SD, .SDcols = scrn_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/Stata/NCAP-Screening.dta")

haven::write_dta(DT[redcap_event_name == "baseline_interview_arm_2", .SD, .SDcols = bl_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/Stata/NCAP-Baseline.dta")

haven::write_dta(DT[redcap_event_name == "followup_interview_arm_2", .SD, .SDcols = fu1_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/Stata/NCAP-Follow1.dta")

haven::write_dta(DT[redcap_event_name == "followup_interview_arm_2b", .SD, .SDcols = fu2_vars],
                 path = "c:/Dbox/NCAP Data/Exported for NCAP Team/Stata/NCAP-Follow2.dta")
```

```{r, eval=FALSE}
with(DT[redcap_event_name == "baseline_interview_arm_2"], descr::freq(vaccine_avail, plot = FALSE))
with(DT[redcap_event_name == "screener_arm_1" & participant_id %in% Enrolled], descr::freq(vaccine_dose, plot = FALSE))
with(DT[redcap_event_name == "screener_arm_1" & participant_id %in% Enrolled], descr::freq(vaccine_manufac_2, plot = FALSE))
DT[!is.na(fu1_q36) & participant_id %in% Enrolled,.(participant_id, redcap_event_name, fu1_q36)]
DT[!is.na(fu1_q36_fu2) & participant_id %in% Enrolled,.(participant_id, redcap_event_name, fu1_q36_fu2)]
with(DT[redcap_event_name == "screener_arm_1"], descr::freq(consent_complete, plot = FALSE))
with(DT[redcap_event_name == "screener_arm_1"], descr::freq(consent_given, plot = FALSE))
with(DT[redcap_event_name == "screener_arm_1"], descr::freq(format(consentdt_mdy, "%Y-%m-%B"), plot = FALSE))
with(DT[redcap_event_name == "screener_arm_1"], descr::freq(consent_recontact, plot = FALSE))
with(DT[redcap_event_name == "screener_arm_1"], descr::freq(consent_zip_2, plot = FALSE))
with(DT[redcap_event_name == "screener_arm_1"], descr::freq(consent_ident, plot = FALSE))
```



